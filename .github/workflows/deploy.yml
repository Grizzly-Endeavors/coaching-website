name: Build and Deploy

on:
  push:
    branches:
      - production

env:
  REGISTRY: 10.0.0.226:32346
  IMAGE_NAME: coaching-website

jobs:
  build-and-deploy:
    runs-on: [self-hosted, kubernetes, lab]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t $REGISTRY/$IMAGE_NAME:${{ github.sha }} \
            --build-arg NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}" \
            --build-arg NEXT_PUBLIC_API_URL="${{ secrets.DOMAIN_NAME }}" \
            --build-arg STRIPE_SECRET_KEY="${{ secrets.STRIPE_SECRET_KEY }}" \
            .
          docker tag $REGISTRY/$IMAGE_NAME:${{ github.sha }} $REGISTRY/$IMAGE_NAME:latest

      - name: Push to registry
        run: |
          docker push $REGISTRY/$IMAGE_NAME:${{ github.sha }}
          docker push $REGISTRY/$IMAGE_NAME:latest

      - name: Copy TLS certificate secret
        run: |
          # Copy the PostgreSQL TLS CA certificate from database namespace
          kubectl get secret postgresql-tls-ca -n database -o yaml | \
            sed 's/namespace: database/namespace: coaching-website/' | \
            kubectl apply -f -

      - name: Deploy to Kubernetes with Helm
        run: |
          helm upgrade --install coaching-website ./helm \
            --create-namespace \
            --namespace coaching-website \
            --set image.tag=latest \
            --set postgresql.username="${{ secrets.POSTGRES_USERNAME_COACHING }}" \
            --set postgresql.password="${{ secrets.POSTGRES_PASSWORD_COACHING }}" \
            --set secrets.nextauthUrl="${{ secrets.NEXTAUTH_URL }}" \
            --set secrets.nextauthSecret="${{ secrets.NEXTAUTH_SECRET }}" \
            --set secrets.discordBotToken="${{ secrets.DISCORD_BOT_TOKEN }}" \
            --set secrets.adminDiscordUserId="${{ secrets.ADMIN_DISCORD_USER_ID }}" \
            --set secrets.adminEmail="${{ secrets.ADMIN_EMAIL }}" \
            --set secrets.discordClientId="${{ secrets.DISCORD_CLIENT_ID }}" \
            --set secrets.discordClientSecret="${{ secrets.DISCORD_CLIENT_SECRET }}" \
            --set secrets.discordRedirectUri="${{ secrets.DISCORD_REDIRECT_URI }}" \
            --set secrets.discordGuildId="${{ secrets.DISCORD_GUILD_ID }}" \
            --set secrets.stripeSecretKey="${{ secrets.STRIPE_SECRET_KEY }}" \
            --set secrets.domainName="${{ secrets.DOMAIN_NAME }}" \
            --set secrets.nextPublicStripePublishableKey="${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}" \
            --set secrets.nextPublicApiUrl="${{ secrets.DOMAIN_NAME }}" \
            --wait \
            --timeout 5m

      - name: Clean up old images
        run: |
          docker image prune -f

      - name: Build summary
        run: |
          echo "✅ Deployed successfully to Kubernetes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- Service: coaching-website" >> $GITHUB_STEP_SUMMARY
          echo "- Image: \`$REGISTRY/$IMAGE_NAME:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Ingress: \`coaching.grizzly-endeavors.com\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "⚠️ **Note**: Database migrations must be run manually if schema changed" >> $GITHUB_STEP_SUMMARY
